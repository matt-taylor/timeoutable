#!/bin/bash -e

if [ -z "$GEMFURY_TOKEN" ]; then
  echo 'Environment variable GEMFURY_TOKEN is not present'
  exit 1
fi


VERSION=$(bin/rails runner 'Timeoutable.get_version')
PACKAGE=timeoutable-${VERSION}.gem

# if [ $(git tag -l "$VERSION") ]; then
#   echo "Pre existing version $VERSION, not tagging."
#   echo "Pre existing version $VERSION, not pushing to gemfury."
#   exit 0
# fi

# Build and publish to Gemfury
gem build timeoutable.gemspec
FILE=$(pwd)/${PACKAGE}
echo "Finished building $FILE"

# push to gemfury
curl --fail -F package=@${FILE} https://${GEMFURY_TOKEN}@push.fury.io/${GEMFURY_USER}/
echo "Finished Pushing to Gemfury"

# start fresh
rm timeoutable.gemspec
